!function(){"use strict";var o=e=>e.match(/((?<=#?\[\[)(.*?)(?=\]\]))|((?<=#)\w+)/g)||[],t=(e,t)=>{for(;0<e.length;){const n=e.shift();try{return"function"==typeof n?n():n}catch(e){}}return t},i=e=>t([()=>e.match(/(?<=-).{9}$(?=[^-]*$)/)[0],()=>(e.match(/uuid[^uuid]*(?=(uuid[^uuid]*){0}$)/)||e.match(/uuid.*$/))[0],()=>e.slice(-9)],""),r=e=>{if(!e||!e.length)return[];const t={};return e.forEach(e=>t[e]=e),Object.keys(t)},c=()=>{var e=[...document.querySelectorAll(".roam-block-container.block-highlight-blue")].map(e=>i(e.querySelector(".rm-block__input").id));return[...new Set(e)]},e=Object.freeze({__proto__:null,extractTags:o,removeTags:e=>e.replace(/(#\[\[(.*?)\]\])|(#\w+)/g,"").trim(),patchBlockChildren:async(e,o,t={})=>{var{skipTop:r=!0,depth:t=1/0}=t,e=await window.roam42.common.getBlockInfoByUID(e,!0);let a=!1;const i=(e,t,n=!0)=>{if(a||!e)return!1;e.forEach(e=>{e=Array.isArray(e)?e[0]:e;e.children&&0<t&&i(e.children,t-1,!1),r&&n||!1===o(e)&&(a=!0)})};i(e,t)},getValueInOrderIfError:t,getBlockUidFromId:i,unique:r,getSelectBlockUids:c,flattenBlocks:function t(e,n){return e.flatMap(e=>e.children?t(e.children,n):n&&!1===n(e)?[]:e)}}),n="object"==typeof global&&global&&global.Object===Object&&global,a="object"==typeof self&&self&&self.Object===Object&&self,l=n||a||Function("return this")(),s=l.Symbol,u=(n=Object.prototype).hasOwnProperty,d=n.toString,p=s?s.toStringTag:void 0,m=Object.prototype.toString,h="[object Null]",g="[object Undefined]",f=s?s.toStringTag:void 0;function y(e){return null==e?void 0===e?g:h:f&&f in Object(e)?function(e){var t=u.call(e,p),n=e[p];try{var o=!(e[p]=void 0)}catch(e){}var r=d.call(e);return o&&(t?e[p]=n:delete e[p]),r}(e):(e=e,m.call(e))}function w(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var v="[object AsyncFunction]",b="[object Function]",k="[object GeneratorFunction]",_="[object Proxy]";function B(e){if(w(e)){e=y(e);return e==b||e==k||e==v||e==_}}var a=l["__core-js_shared__"],C=(n=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"",x=Function.prototype.toString,T=/^\[object .+?Constructor\]$/,a=Function.prototype,n=Object.prototype,a=a.toString,n=n.hasOwnProperty,z=RegExp("^"+a.call(n).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function E(e){var t;return w(e)&&(t=e,!(C&&C in t))&&(B(e)?z:T).test(function(e){if(null!=e){try{return x.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function O(e,t){t=t,t=null==(e=e)?void 0:e[t];return E(t)?t:void 0}var U=O(Object,"create"),$=Object.prototype.hasOwnProperty,S=Object.prototype.hasOwnProperty;function j(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function N(e,t){for(var n,o,r=e.length;r--;)if((n=e[r][0])===(o=t)||n!=n&&o!=o)return r;return-1}j.prototype.clear=function(){this.__data__=U?U(null):{},this.size=0},j.prototype.delete=function(e){return e=this.has(e)&&delete this.__data__[e],this.size-=e?1:0,e},j.prototype.get=function(e){var t=this.__data__;if(U){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return $.call(t,e)?t[e]:void 0},j.prototype.has=function(e){var t=this.__data__;return U?void 0!==t[e]:S.call(t,e)},j.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=U&&void 0===t?"__lodash_hash_undefined__":t,this};var P=Array.prototype.splice;function I(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}I.prototype.clear=function(){this.__data__=[],this.size=0},I.prototype.delete=function(e){var t=this.__data__;return!((e=N(t,e))<0)&&(e==t.length-1?t.pop():P.call(t,e,1),--this.size,!0)},I.prototype.get=function(e){var t=this.__data__;return(e=N(t,e))<0?void 0:t[e][1]},I.prototype.has=function(e){return-1<N(this.__data__,e)},I.prototype.set=function(e,t){var n=this.__data__,o=N(n,e);return o<0?(++this.size,n.push([e,t])):n[o][1]=t,this};var A=O(l,"Map");function L(e,t){var n,o=e.__data__;return("string"==(e=typeof(n=t))||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function D(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function M(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new D;++t<n;)this.add(e[t])}function q(e){return e!=e}function R(e,t,n){return t==t?function(e,t,n){for(var o=n-1,r=e.length;++o<r;)if(e[o]===t)return o;return-1}(e,t,n):function(e,t,n,o){for(var r=e.length,a=n+(o?1:-1);o?a--:++a<r;)if(t(e[a],a,e))return a;return-1}(e,q,n)}function F(e,t){return!!(null==e?0:e.length)&&-1<R(e,t,0)}function K(e,t,n){for(var o=-1,r=null==e?0:e.length;++o<r;)if(n(t,e[o]))return!0;return!1}function H(e,t){return e.has(t)}function Y(e,t,n,o){var r,a=-1,i=F,c=!0,l=e.length,s=[],u=t.length;if(!l)return s;n&&(t=function(e,t){for(var n=-1,o=null==e?0:e.length,r=Array(o);++n<o;)r[n]=t(e[n],n,e);return r}(t,(r=n,function(e){return r(e)}))),o?(i=K,c=!1):200<=t.length&&(i=H,c=!1,t=new M(t));e:for(;++a<l;){var d=e[a],p=null==n?d:n(d),d=o||0!==d?d:0;if(c&&p==p){for(var m=u;m--;)if(t[m]===p)continue e;s.push(d)}else i(t,p,o)||s.push(d)}return s}function G(e){return null!=e&&"object"==typeof e}function J(e){return G(e)&&"[object Arguments]"==y(e)}D.prototype.clear=function(){this.size=0,this.__data__={hash:new j,map:new(A||I),string:new j}},D.prototype.delete=function(e){return e=L(this,e).delete(e),this.size-=e?1:0,e},D.prototype.get=function(e){return L(this,e).get(e)},D.prototype.has=function(e){return L(this,e).has(e)},D.prototype.set=function(e,t){var n=L(this,e),o=n.size;return n.set(e,t),this.size+=n.size==o?0:1,this},M.prototype.add=M.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},M.prototype.has=function(e){return this.__data__.has(e)};var V=(l=Object.prototype).hasOwnProperty,W=l.propertyIsEnumerable,X=J(function(){return arguments}())?J:function(e){return G(e)&&V.call(e,"callee")&&!W.call(e,"callee")},Q=Array.isArray,Z=s?s.isConcatSpreadable:void 0;function ee(e){return Q(e)||X(e)||!!(Z&&e&&e[Z])}function te(e,t,n,o,r){var a=-1,i=e.length;for(n=n||ee,r=r||[];++a<i;){var c=e[a];0<t&&n(c)?1<t?te(c,t-1,n,o,r):function(e,t){for(var n=-1,o=t.length,r=e.length;++n<o;)e[r+n]=t[n]}(r,c):o||(r[r.length]=c)}return r}function ne(e){return e}var oe=Math.max;function re(a,i,c){return i=oe(void 0===i?a.length-1:i,0),function(){for(var e=arguments,t=-1,n=oe(e.length-i,0),o=Array(n);++t<n;)o[t]=e[i+t];for(var t=-1,r=Array(i+1);++t<i;)r[t]=e[t];return r[i]=c(o),function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}(a,this,r)}}var ae,ie,ce,le=function(){try{var e=O(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),s=le?function(e,t){return le(e,"toString",{configurable:!0,enumerable:!1,value:(n=t,function(){return n}),writable:!0});var n}:ne,se=Date.now,n=(ae=s,ce=ie=0,function(){var e=se(),t=16-(e-ce);if(ce=e,0<t){if(800<=++ie)return arguments[0]}else ie=0;return ae.apply(void 0,arguments)}),ue=9007199254740991;function de(e){return null!=e&&("number"==typeof(t=e.length)&&-1<t&&t%1==0&&t<=ue)&&!B(e);var t}function pe(e){return G(e)&&de(e)}var me=n(re(l=function(e,t){return pe(e)?Y(e,te(t,1,pe,!0)):[]},qe,ne),l+""),s=Object.freeze({__proto__:null,testIfRoamDateAndConvert:e=>{try{return window.roam42.dateProcessing.testIfRoamDateAndConvert(e)}catch{return!1}}}),he=async(n,o=0,e,r=e=>e)=>{e.forEach(async(e,t)=>{await window.roam42.common.createBlock(n,t+o,`${r(e)}`)})},ge=async(e,t,n={})=>{const{textKey:c="text",childrenKey:l="children",shouldOrder:s=!1,startOrder:o=0,afterCreateBlock:u,renderItem:d=e=>e}=n;let p=!1;await async function t(n,e,o){var r=s?e.sort((e,t)=>e.order-t.order):e;for(let e=0;e<r.length;e++){if(!n)return;var a=r[e],i=d(a[c],a);i&&(i=await window.roam42.common.createBlock(n,o+e,i),!p&&!1!==(null===u||void 0===u?void 0:u(a,i))||(p=!0),a[l]&&t(i,a[l],o))}}(e,t,o)},fe=()=>{let t=null;var e;try{t=document.querySelector("textarea.rm-block-input").id}catch(e){t=document.activeElement.id}return t||(console.log("id 都获取不到"),window.roam42.help.displayMessage("id 都获取不到",2e3)),e=i(t),console.log("getCurrentBlockUid",{res:e,id:t}),e||window.roam42.help.displayMessage("获取不到当前 block uid",2e3),e},ye=(e=document.activeElement)=>{try{return e.closest(".rm-block-children").closest(".roam-block-container")}catch(e){return console.log("getParentBlockNode error",e),null}},we=async(e=document.activeElement)=>{try{return(await window.roam42.common.getDirectBlockParentUid(fe())).parentUID}catch(e){return console.log(e),window.roam42.help.displayMessage("getParentBlockUid 执行出错",2e3),null}},ve=e=>{try{return e.querySelector(".rm-block-children .roam-block-container:last-child").querySelector(".rm-block-main .rm-block__input").id.slice(-9)}catch(e){return console.log("getLastChildUid error",e),null}},be=async(e=fe(),t=!1)=>{var n=await window.roam42.common.getBlockInfoByUID(e,t);try{return n[0][0]}catch(e){console.log(n),window.roam42.help.displayMessage("getCurrentBlockInfo 执行出错",2e3)}},ke=async(e,t={})=>{var{isAsync:t=!1,deleteCurrentBlock:n=!1}=t,o=document.activeElement.value;t&&(document.activeElement.value+="fetching...");try{var r=fe(),a=await e({currentBlockContent:o,currentBlockUid:r});return n&&window.roam42.common.deleteBlock(r),document.activeElement.value=o,n||window.roam42.common.updateBlock(fe(),o),a}catch(e){console.log("outputBlocks error",e),roam42.help.displayMessage("outputBlocks 执行出错",2e3)}};function _e(e,t={}){return new Promise(o=>{window.iziToast.question({timeout:1e4,close:!1,overlay:!0,displayMode:1,id:"question",zindex:999,title:e,position:"topCenter",buttons:[[`<button><b>${"zh-CN"===navigator.language?"是":"YES"}</b></button>`,function(e,t){e.hide({transitionOut:"fadeOut"},t,"true")},!0],[`<button>${"zh-CN"===navigator.language?" 否":"NO"}</button>`,function(e,t){e.hide({transitionOut:"fadeOut"},t,"false")},!1]],onClosing:function(e,t,n){o("timeout"!==n&&JSON.parse(n))},...t})})}var Be={common:Object.freeze({__proto__:null,batchCreateBlocks:he,deepCreateBlock:ge,copyTemplateBlock:async(e,t,n={})=>{var{startOrder:o=0,afterCreateBlock:r,renderItem:a,childrenKey:i,textKey:c}=n;"string"==typeof t?(n=await window.roam42.common.getBlockInfoByUID(t,!0))&&ge(e,n[0][0].children,{shouldOrder:!0,startOrder:o,textKey:c||"string",childrenKey:i||"children",afterCreateBlock:r,renderItem:a}):ge(e,t,{textKey:c||"text",childrenKey:i||"children",shouldOrder:!0,startOrder:o,afterCreateBlock:r,renderItem:a})},getCurrentPageTitle:(e=document.activeElement)=>t([()=>e.closest(".rm-ref-page-view").querySelector(".rm-ref-page-view-title").innerText,()=>e.closest(".roam-log-page").querySelector(".rm-title-display").innerText,()=>e.closest(".roam-article").querySelector(".rm-title-display").innerText,()=>e.closest(".roam-article").querySelector(".rm-zoom-item").innerText,()=>e.closest(".rm-sidebar-outline").querySelector(".rm-title-display").innerText,()=>e.closest(".rm-sidebar-outline").querySelector(".rm-zoom-item").innerText],"404"),getCurrentBlockUid:fe,deleteCurrentBlock:async(e=fe())=>{e&&await window.roam42.common.deleteBlock(e)},getParentBlockNode:ye,getParentBlockUid:we,getLastChildUidByNode:ve,getLastChildUidByUid:async(e=we())=>{try{const t=await window.roam42.common.getBlockInfoByUID(e,!0);return t[0][0].children.sort((e,t)=>e.sort-t.sort).slice(-1)[0].uid}catch(e){return console.log("getLastChildUid error",e),null}},getLastBilingBlockUid:async()=>{try{return ve(ye())}catch(e){return console.log("getLastBilingBlockUid error",e),null}},getCurrentBlockInfo:be,outputBlocks:ke,updateCurrentBlock:async(e,t={})=>{var{isAsync:t=!1}=t,n=document.activeElement.value;t&&(document.activeElement.value+="fetching...");try{var o=fe(),r="function"==typeof e?await e({currentBlockContent:n,currentBlockUid:o}):e;return document.activeElement.value=r,window.roam42.common.updateBlock(o,r),r}catch(e){console.log("updateCurrentBlock error",e),window.roam42.help.displayMessage("updateCurrentBlock 执行出错",2e3)}},outputListIntoOne:async({title:e,output:t,parentBlockUid:n,order:o,renderItem:r=e=>e,customOutput:a})=>{if(0<(null==t?void 0:t.length)){o=o||(await be()).order||99999;n=n||await we(),e=await window.roam42.common.createBlock(n,o,e);return a?a(e,o):await he(e,o,t,r),e}console.log("outputListIntoOne","output 为空")},outputBlocksRightHere:async(o,e={})=>{const{isAsync:t=!1,deleteCurrentBlock:n=!1,renderItem:r=e=>e,toChild:a=!1}=e;await ke(async({currentBlockUid:e})=>{var t=a?e:await we(),n=a?99999:(await be(e)).order+1,e="function"==typeof o?await o({currentBlockUid:e}):o;Array.isArray(e)?await he(t,n,e,r):await window.roam42.common.createBlock(t,n,r(e))},{isAsync:t,deleteCurrentBlock:!a&&n})},getTags:async n=>{try{var e=(await window.roam42.common.getBlocksReferringToThisPage(n)||[]).reduce((e,t)=>[...e,t[0],...t[0].children&&new RegExp(String.raw`((^\[\[${n}\]\]$|)|(${n}\:\:))`).test(t[0].string)?t[0].children:[]],[]).reduce((e,t)=>[...e,...o(t.string)],[]);return e.length||window.roam42.help.displayMessage(`getOptions: ${n}获取不到索引`,2e3),r(e)}catch(e){console.log("getTags error",e),window.roam42.help.displayMessage("getTags 执行出错",2e3)}}}),utils:e,dateProcessing:s,help:Object.freeze({__proto__:null,confirm:_e,prompt:function(e,t={}){return new Promise(o=>{let r;window.iziToast.info({timeout:2e4,overlay:!0,displayMode:1,id:"inputs",zindex:999,title:e,position:"topCenter",drag:!1,inputs:[['<input type="text">',"keyup",function(e,t,n,o){r=n.value},!0]],buttons:[["<button><b>YES</b></button>",function(e,t){e.hide({transitionOut:"fadeOut"},t,r)},!1],["<button>NO</button>",function(e,t){e.hide({transitionOut:"fadeOut"},t,"")},!1]],onClosing:function(e,t,n){o("timeout"!==n&&n||"")},...t})})}})};const Ce=async(e,t,n,o,r)=>{var a,{currentUid:i,selectUids:c,target:l,pageTitle:s}=o,u=t.string.match(/^\`\`\`javascript\n([\s\S]*)\`\`\`$/);if(u){var d=u[1];const m=Object.getPrototypeOf(async function(){}).constructor;try{var p=await new m("$ctx","$currentUid","$selectUids","$target","$pageTitle",d)(r,i,c,l,s);return null!==(a=t.children)&&void 0!==a&&a.length||p?await window.roam42.common.createBlock(e,t.order,`${p||""}`):void 0}catch(e){return console.log(e),void window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?"执行错误":"task error"})}}u=t.string.match(/<%\s*menu:\s*(.*)\s*%>/);if(!u)return await window.roam42.common.createBlock(e,t.order,await window.roam42.smartBlocks.proccessBlockWithSmartness(t.string));{const h=n[u[1]];h?h.onClick&&h.onClick(o):window.iziToast.error({title:"zh-CN"===navigator.language?`不存在 menu: ${u[1]}`:`no menu named${u[1]} found`,position:"topCenter",timeout:3e3})}};var xe=[{text:"Delete",key:"Delete",children:[{text:"Delete block and its references",key:"Delete block and its references",onClick:async({currentUid:e,selectUids:t})=>{await _e("zh-CN"===navigator.language?"确定删除当前所选 block 及其所有块引用":"Sure to delete the current block and its all references??")&&[e,...t].forEach(async e=>{const t=await window.roam42.common.getBlocksReferringToThisBlockRef(e);0<t.length&&t.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)),window.roam42.common.deleteBlock(e)})}},{text:"Delete current block and embed block's refers",key:"Delete current block and embed block's refers",onClick:async({currentUid:e})=>{try{const n=await Be.common.getCurrentBlockInfo(e);var t=n.string.match(/\{\{\[\[embed\]\]\:\s+\(\(\(\((.*?)\)\)\)\)\}\}/);if(t){t=t[1];const o=await window.roam42.common.getBlocksReferringToThisBlockRef(t);0<o.length&&await _e(`该 block 包含有 embed，embed 原 block有${o.length}个块引用，是否一起删除`)&&(o.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)),window.roam42.common.deleteBlock(t),window.roam42.help.displayMessage(`删除${o.length}个引用`,2e3),window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?`删除${o.length}个引用`:`delete${o.length} references`}))}window.roam42.common.deleteBlock(e)}catch(e){console.log(e),window.iziToast.error({title:"zh-CN"===navigator.language?"删除出错":"Delete failed"})}}}]},{text:"Format",key:"Format",children:[{text:"Remove tags",key:"Remove tags",onClick:async({currentUid:e,selectUids:t})=>{[e,...t].forEach(async e=>{var t=await Be.common.getCurrentBlockInfo(e);await window.roam42.common.updateBlock(e,Be.utils.removeTags(t.string))})}}]},{text:"Format child blocks",key:"Format child blocks",children:[{text:"Embed to text",key:"Child embed to text",onClick:async({currentUid:e})=>{await Be.utils.patchBlockChildren(e,async e=>{var t=e.string.match(/\{\{\[\[embed\]\]\:\s+\(\(\(\((.*?)\)\)\)\)\}\}/),t=t&&t[1];t&&(t=await window.roam42.common.getBlockInfoByUID(t),window.roam42.common.updateBlock(e.uid,t[0][0].string))})}},{text:"Remove tags",key:"Child blocks remove tags",onClick:async({currentUid:e})=>{Be.utils.patchBlockChildren(e,e=>{var t=Be.utils.removeTags(e.string);t!==e.string&&window.roam42.common.updateBlock(e.uid,t)})}},{text:"Merge blocks",key:"Merge child blocks",onClick:async({currentUid:o})=>{var r=+window.prompt("zh-CN"===navigator.language?"每多少行为一组进行合并？":"How many lines into one?");if(r){var a=window.prompt("zh-CN"===navigator.language?" 前缀？":"prefix?");const e=await window.roam42.common.getBlockInfoByUID(o,!0);var i=e[0][0].children.sort((e,t)=>e.order-t.order);let t="",n=0;for(let e=0;e<i.length;e++){var c=i[e];window.roam42.common.deleteBlock(c.uid),t+=`${t?"\n":""}${c.string}`,(e>r-2&&(e+1)%r==0||e===i.length-1)&&(window.roam42.common.createBlock(o,n++,`${a}${t}`),t="")}}}}]},{text:"Cloze",key:"Cloze",children:[{text:"Expand all",key:"Expand all cloze",onClick:async({target:e})=>{e.closest(".roam-block-container").querySelectorAll(".rm-block-children .rm-paren > .rm-spacer").forEach(e=>e.click())}},{text:"Collapse all",key:"Collapse all cloze",onClick:async({target:e})=>{e.closest(".roam-block-container").querySelectorAll(".rm-block-children .rm-paren__paren").forEach(e=>e.click())}}]},{text:"Extract",children:[{text:"All children's highlight",key:"Extract All children's highlight",onClick:async({currentUid:e})=>{let t=[];await Be.utils.patchBlockChildren(e,e=>{e=e.string.match(/\^\^([\s\S]*?)\^\^/g);e&&t.push(...e)}),await navigator.clipboard.writeText(t.join("\n")),0<t.length?window.iziToast.success({title:"zh-CN"===navigator.language?"提取高亮成功，已复制到剪切板":"Extract successfully, Copied to clipboard!"}):window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?"提取不到高亮内容":"Can't extract anything"})}}]}],Te=[{text:"Clear current page",key:"Clear current page",onClick:async({currentUid:e})=>{if(await Be.help.confirm("zh-CN"===navigator.language?"确定清空当前页吗？":"Are you sure to clear the current page?")){const t=await window.roam42.common.getBlockInfoByUID(e,!0);t[0][0].children.forEach(e=>{window.roam42.common.deleteBlock(e.uid)})}}},{text:"Delete all refering blocks",key:"Delete all refering blocks",onClick:async({pageTitle:e})=>{const t=await window.roam42.common.getBlocksReferringToThisPage(e);t.length?await _e("zh-CN"===navigator.language?`当前页面有${t.length}个引用，是否全部删除？`:`Current page has ${t.length} references, remove all?`)&&t.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)):window.iziToast.info({title:"zh-CN"===navigator.language?"该页面没有引用":"This page has no reference",position:"topCenter",timeout:2e3})}},{text:"Extract currentPage's refers",key:"Extract currentPage's refers",onClick:async({pageTitle:e})=>{const t=await window.roam42.common.getBlocksReferringToThisPage(e);if(t.length){var n=t.reduce((e,t)=>{return e[t[0].uid]=t,e},{});const o=await window.roam42.common.getPageNamesFromBlockUidList(t.map(e=>e[0].uid)),r=o.sort((e,t)=>+new Date(e[1].uid)&&+new Date(t[1].uid)&&+new Date(e[1].uid)>+new Date(t[1].uid)?1:-1).reduce((e,t,n)=>{var o=t[1].uid;return e[o]=[...e[o]||[],{...t[0],title:t[1].title}],e},{});e=Object.keys(r).map(e=>`${r[e][0].title}
          ${r[e].map(e=>{e=e.uid;return"    "+function t(e,n=2){return`${e.string}
              ${e.children?e.children.map(e=>"    ".repeat(n)+t(e,n+1)).join("\n"):""}`}(n[e][0])}).join("\n")}`).join("\n");await navigator.clipboard.writeText(e),window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?"提取成功，已复制到剪切板":"Extract successfullly, Copied to clipboard!"})}else window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?"提取不到东西":"Can't extract anything"})}}],ze=[{text:"Focus on page",key:"Focus on page",onClick:async({pageTitle:e})=>{await window.roam42.common.navigateUiTo(e)}},...Te];function Ee(e){const t={},n=e=>{e.forEach(e=>{e.children?n(e.children):t[e.key]=e})};return n(e),t}async function Oe(e,n){return e&&e.length?await Promise.all(e.map(async t=>{if(null===(e=t.children)||void 0===e||!e.length)return{text:t.string,onClick:()=>{window.iziToast.info({title:"zh-CN"===navigator.language?"该菜单没有配置执行任务":"This menu has no configuration",position:"topCenter",timeout:2e3})}};var e=t.string.match(/\{\{(.*)\}\}/);return e?{text:e[1],onClick:async e=>{await async function(e,r,a){var{currentUid:t,pageTitle:n}=a;let o;t?o=t:n&&(o=await window.roam42.common.getPageUidByTitle(n));const i=async(e,t)=>{for(const o of t.sort((e,t)=>e.order-t.order)){var n=await Ce(e,o,r,a,c);o.children&&i(n||e,o.children)}};let c={};await i(o,e),c={}}(t.children.sort((e,t)=>e.order-t.order),n,e)}}:{text:t.string,children:await Oe(t.children,n)}})):[]}async function Ue(e,t,n){const o=e.find(e=>e.string.includes(t));return o?await Oe(o&&o.children.sort((e,t)=>e.order-t.order)||[],Ee(n)):n}const $e={},Se=(e,t="")=>e.map(e=>e.children&&e.children.length?`<li class="bp3-submenu">
                        <span class="bp3-popover-wrapper">
                            <span class="bp3-popover-target">
                                <a class="bp3-menu-item" tabindex="0" data-key="${t+e.text}">
                                    <div class="bp3-text-overflow-ellipsis bp3-fill">${e.text}</div>
                                    <span icon="caret-right" class="bp3-icon bp3-icon-caret-right">
                                        <svg data-icon="caret-right" width="16" height="16" viewBox="0 0 16 16">
                                            <desc>caret-right</desc><path d="M11 8c0-.15-.07-.28-.17-.37l-4-3.5A.495.495 0 006 4.5v7a.495.495 0 00.83.37l4-3.5c.1-.09.17-.22.17-.37z" fill-rule="evenodd">
                                            </path>
                                        </svg>
                                    </span>
                                </a>
                            </span>
                            <div class="bp3-overlay bp3-overlay-inline">
                                <div class="bp3-transition-container bp3-popover-appear-done bp3-popover-enter-done" style="position: absolute; will-change: transform; top: 0px; left: 100%; /*transform: translate3d(183px, 0px, 0px);*/">
                                    <div class="bp3-popover bp3-minimal bp3-submenu" style="transform-origin: left center;">
                                        <div class="bp3-popover-content">
                                            <ul class="bp3-menu">
                                                ${Se(e.children,t+(e.key||e.text))}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </span>
                    </li>`:($e[t+(e.key||e.text)]=e.onClick,`<li>
                        <a class="bp3-menu-item bp3-popover-dismiss" data-key="${t+(e.key||e.text)}">
                            <div class="bp3-text-overflow-ellipsis bp3-fill">${e.text}</div>
                        </a>
                    </li>`)).join("");let je,Ne;document.addEventListener("mousedown",e=>{je=e.clientX,Ne=e.clientY});const Pe=new MutationObserver(async(n,e)=>{if(!!n.find(e=>"childList"===e.type&&("bp3-context-menu"===e.target.className||"bp3-context-menu-popover-target"===e.target.className))){let t=n.find(e=>"childList"===e.type&&0<e.addedNodes.length&&"bp3-portal"===e.target.className);if(t){const o=document.elementsFromPoint(je,Ne),r={};let e=null;r.target=o[1];const a=o.find(e=>e.classList.contains("rm-block-main"));a&&(r.currentUid=i(a.querySelector(".rm-block__input").id),e="block");n=o.find(e=>e.classList.contains("rm-title-display"));n&&(r.pageTitle=n.innerText,r.currentUid=await window.roam42.common.getPageUidByTitle(r.pageTitle),e=o.find(e=>e.classList.contains("sidebar-content"))?"pageTitle_sidebar":"pageTitle");n=await async function(t,n){var e=await window.roam42.common.getPageUidByTitle("roam/enhance/menu");let o;if(e){const r=await window.roam42.common.getBlockInfoByUID(e,!0);r&&(o=r[0][0].children.sort((e,t)=>e.order-t.order))}if(o){if("block"===t)return await Ue(o,"BlockMenu",xe);let e;return"pageTitle"===t?e=await Ue(o,"PageTitleMenu",Te):"pageTitle_sidebar"===t&&(e=await Ue(o,"PageTitleMenu_Sidebar",ze)),"roam/enhance/menu"===n.pageTitle&&e.push({text:"Pull all build-in menu",onClick:async()=>{var e=await window.roam42.common.getPageUidByTitle("roam/enhance/menu");const t=e=>e.map(e=>e.children?{...e,children:t(e.children)}:{...e,text:`{{${e.text}}}`,children:[{text:`<%menu:${e.key}%>`}]});ge(e,[{text:"**BlockMenu**",children:t(xe)},{text:"**PageTitleMenu**",children:t(Te)},{text:"**PageTitleMenu_Sidebar**",children:t(ze)}])}},{text:"Pull unused build-in menu",onClick:async({currentUid:e})=>{const t=[];await Be.utils.patchBlockChildren(e,e=>{e=e.string.match(/<%\s*menu:\s*(.*)\s*%>/);e&&t.push(e[1])});var n=Object.keys({...Ee(xe),...Ee(Te),...Ee(ze)}),n=me(n,t).map(e=>`<%menu:${e}%>`);n.length?await Be.common.batchCreateBlocks(e,0,n):window.iziToast.info({position:"topCenter",title:"zh-CN"===navigator.language?"当前没有未使用的内置菜单":"No unused build-in menu found"})}}),null!==(n=null===(n=window.roamEnhance)||void 0===n?void 0:n.plugins)&&void 0!==n&&n.includes("metadata"),e}}((o,e),r);r.selectUids=c(),n&&function(e,t,o){const n=document.createElement("template");n.innerHTML=Se(t),[...n.content.childNodes].forEach(e=>{e.addEventListener("click",async e=>{const t=e.target;if(t.classList.contains("bp3-menu-item")||t.classList.contains("bp3-fill")&&t.classList.contains("bp3-text-overflow-ellipsis")){const n=$e[t.closest(".bp3-menu-item").dataset.key];if(n)try{await n(o)}catch(e){console.log(e),window.iziToast.error({title:"操作失败",position:"topCenter",timeout:3e3})}}}),[...e.querySelectorAll(".bp3-popover-wrapper")].forEach(e=>{e.addEventListener("mouseenter",async e=>{const t=e.target;t.parentNode.classList.contains("bp3-submenu")&&(t.querySelector(".bp3-popover-target").classList.add("bp3-popover-open"),t.querySelector(".bp3-overlay").classList.add("bp3-overlay-open"))}),e.addEventListener("mouseleave",async e=>{const t=e.target;t.parentNode.classList.contains("bp3-submenu")&&(t.querySelector(".bp3-popover-target").classList.remove("bp3-popover-open"),t.querySelector(".bp3-overlay").classList.remove("bp3-overlay-open"))})})});const r=document.createElement("li");r.className="bp3-menu-divider",n.content.childNodes[n.content.childNodes.length-1].after(r),e.prepend(n.content)}(t.target.querySelector("ul.bp3-menu"),n,r)}}});!function(e,o=""){let r=0;setTimeout(()=>function t(e){var n;try{e()}catch(e){console.log("error",e),r<5&&setTimeout(()=>t(++r),3e3),5<r&&null!==(n=window.roam42)&&void 0!==n&&n.help.displayMessage(`${o}加载失败`,2e3)}}(e),3e3)}(()=>{Pe.observe(document.body,{attributes:!1,childList:!0,subtree:!0})});var Ie,Ae,Le,De,Me,n=[],qe=[];function Re(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),Ie.attributes)for(var t=Object.keys(Ie.attributes),n=0;n<t.length;n++)e.setAttribute(t[n],Ie.attributes[t[n]]);var o="prepend"==Ae?"afterbegin":"beforeend";return Le.insertAdjacentElement(o,e),e}Ie={},(l=".bp3-submenu .bp3-overlay:not(.bp3-overlay-open) {\n  display: none;\n}\n.bp3-submenu > .bp3-popover-wrapper {\n  position: relative;\n}\n.iziToast > .iziToast-body .iziToast-buttons {\n  float: none;\n  text-align: center;\n  margin-left: -28px;\n}\n.iziToast > .iziToast-body .iziToast-icon {\n  top: 20px;\n}\n.iziToast-buttons .iziToast-buttons-child {\n  top: 6px;\n}\n\n.ant-cascader-menus {\n  z-index: 1400;\n}\n")&&"undefined"!=typeof document&&(Ae=!0===Ie.prepend?"prepend":"append",e=!0===Ie.singleTag,Le="string"==typeof Ie.container?document.querySelector(Ie.container):document.getElementsByTagName("head")[0],De=e?(-1===(De=n.indexOf(Le))&&(De=n.push(Le)-1,qe[De]={}),qe[De]&&qe[De][Ae]?qe[De][Ae]:qe[De][Ae]=Re()):Re(),65279===l.charCodeAt(0)&&(l=l.substring(1)),De.styleSheet?De.styleSheet.cssText+=l:De.appendChild(document.createTextNode(l))),void 0===window.roamEnhance&&(window.roamEnhance=Be,window.roamEnhance.host=document.currentScript.src.replace("main.js",""),window.roamEnhance._plugins={},null!==(s=window.roamEnhance)&&void 0!==s&&s.plugins.length&&null!==(Me=window.roamEnhance)&&void 0!==Me&&Me.plugins.forEach(e=>{!function(e,t){const n=document.getElementById(t);n&&n.remove();const o=document.createElement("script");o.src=e,t&&(o.id=t),o.async=!0,o.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(o)}(`${window.roamEnhance.host}plugin/${e}`,e)}),window.yoyo=window.roamEnhance)}();
