!function(){"use strict";var o=e=>e.match(/((?<=#?\[\[)(.*?)(?=\]\]))|((?<=#)\w+)/g)||[],t=(e,t)=>{for(;0<e.length;){const n=e.shift();try{return"function"==typeof n?n():n}catch(e){}}return t},i=e=>t([()=>e.match(/(?<=-).{9}$(?=[^-]*$)/)[0],()=>(e.match(/uuid[^uuid]*(?=(uuid[^uuid]*){0}$)/)||e.match(/uuid.*$/))[0],()=>e.slice(-9)],""),r=e=>{if(!e||!e.length)return[];const t={};return e.forEach(e=>t[e]=e),Object.keys(t)},c=()=>{var e=[...document.querySelectorAll(".roam-block-container.block-highlight-blue")].map(e=>i(e.querySelector(".rm-block__input").id));return[...new Set(e)]},e=Object.freeze({__proto__:null,extractTags:o,removeTags:e=>e.replace(/(#\[\[(.*?)\]\])|(#\w+)/g,"").trim(),patchBlockChildren:async(e,n,t={})=>{var{skipTop:o=!0}=t,e=await window.roam42.common.getBlockInfoByUID(e,!0);const r=(e,t=!0)=>{if(!e)return!1;e.forEach(e=>{e=Array.isArray(e)?e[0]:e;e.children&&r(e.children,!1),o&&t||n(e)})};r(e)},getValueInOrderIfError:t,getBlockUidFromId:i,unique:r,getSelectBlockUids:c}),n=Object.freeze({__proto__:null,testIfRoamDateAndConvert:e=>{try{return window.roam42.dateProcessing.testIfRoamDateAndConvert(e)}catch{return!1}}}),l=async(n,o,e,r=e=>e)=>{e.forEach(async(e,t)=>{await window.roam42.common.createBlock(n,t+o,`${r(e)}`)})},s=async(e,t,n={})=>{const{textKey:c="text",childrenKey:l="children",shouldOrder:s=!1,startOrder:o=0}=n;await async function t(n,e,o){var r=s?e.sort((e,t)=>e.order-t.order):e;for(let e=0;e<r.length;e++){if(!n)return;var a=r[e],i=await window.roam42.common.createBlock(n,o+e,a[c]);a[l]&&t(i,a[l],o)}}(e,t,o)},u=()=>{let t=null;var e;try{t=document.querySelector("textarea.rm-block-input").id}catch(e){t=document.activeElement.id}return t||(console.log("id 都获取不到"),window.roam42.help.displayMessage("id 都获取不到",2e3)),e=i(t),console.log("getCurrentBlockUid",{res:e,id:t}),e||window.roam42.help.displayMessage("获取不到当前 block uid",2e3),e},a=(e=document.activeElement)=>{try{return e.closest(".rm-block-children").closest(".roam-block-container")}catch(e){return console.log("getParentBlockNode error",e),null}},d=async(e=document.activeElement)=>{try{return(await window.roam42.common.getDirectBlockParentUid(u())).parentUID}catch(e){return console.log(e),window.roam42.help.displayMessage("getParentBlockUid 执行出错",2e3),null}},m=e=>{try{return e.querySelector(".rm-block-children .roam-block-container:last-child").querySelector(".rm-block-main .rm-block__input").id.slice(-9)}catch(e){return console.log("getLastChildUid error",e),null}},p=async(e=u(),t=!1)=>{var n=await window.roam42.common.getBlockInfoByUID(e,t);try{return n[0][0]}catch(e){console.log(n),window.roam42.help.displayMessage("getCurrentBlockInfo 执行出错",2e3)}},h=async(e,t={})=>{var{isAsync:t=!1,deleteCurrentBlock:n=!1}=t,o=document.activeElement.value;t&&(document.activeElement.value+="fetching...");try{var r=u(),a=await e({currentBlockContent:o,currentBlockUid:r});return n&&window.roam42.common.deleteBlock(r),document.activeElement.value=o,n||window.roam42.common.updateBlock(u(),o),a}catch(e){console.log("outputBlocks error",e),roam42.help.displayMessage("outputBlocks 执行出错",2e3)}},g={common:Object.freeze({__proto__:null,batchCreateBlocks:l,deepCreateBlock:s,copyTemplateBlock:async(e,t,n=0)=>{var o;"string"==typeof t?(o=await window.roam42.common.getBlockInfoByUID(t))&&s(e,o[0],{textKey:"string",shouldOrder:!0,startOrder:n}):s(e,t,{textKey:"string",shouldOrder:!0,startOrder:n})},getCurrentPageTitle:()=>t([()=>document.activeElement.closest(".rm-ref-page-view").querySelector(".rm-ref-page-view-title").innerText,()=>document.activeElement.closest(".roam-log-page").querySelector(".rm-title-display").innerText,()=>document.activeElement.closest(".roam-article").querySelector(".rm-title-display").innerText,()=>document.activeElement.closest(".roam-article").querySelector(".rm-zoom-item").innerText,()=>document.activeElement.closest(".rm-sidebar-outline").querySelector(".rm-title-display").innerText,()=>document.activeElement.closest(".rm-sidebar-outline").querySelector(".rm-zoom-item").innerText],"xxx"),getCurrentBlockUid:u,deleteCurrentBlock:async(e=u())=>{e&&await window.roam42.common.deleteBlock(e)},getParentBlockNode:a,getParentBlockUid:d,getLastChildUidByNode:m,getLastChildUidByUid:async(e=d())=>{try{const t=await window.roam42.common.getBlockInfoByUID(e,!0);return t[0][0].children.sort((e,t)=>e.sort-t.sort).slice(-1)[0].uid}catch(e){return console.log("getLastChildUid error",e),null}},getLastBilingBlockUid:async()=>{try{return m(a())}catch(e){return console.log("getLastBilingBlockUid error",e),null}},getCurrentBlockInfo:p,outputBlocks:h,updateCurrentBlock:async(e,t={})=>{var{isAsync:t=!1}=t,n=document.activeElement.value;t&&(document.activeElement.value+="fetching...");try{var o=u(),r="function"==typeof e?await e({currentBlockContent:n,currentBlockUid:o}):e;return document.activeElement.value=r,window.roam42.common.updateBlock(o,r),r}catch(e){console.log("updateCurrentBlock error",e),window.roam42.help.displayMessage("updateCurrentBlock 执行出错",2e3)}},outputListIntoOne:async({title:e,output:t,parentBlockUid:n,order:o,renderItem:r=e=>e,customOutput:a})=>{t&&0<t.length?(o=o||(await p()).order||99999,n=n||await d(),e=await window.roam42.common.createBlock(n,o,e),a?a(e,o):await l(e,o,t,r)):console.log("outputListIntoOne","output 为空")},outputBlocksRightHere:async(o,e={})=>{const{isAsync:t=!1,deleteCurrentBlock:n=!1,renderItem:r=e=>e,toChild:a=!1}=e;await h(async({currentBlockUid:e})=>{var t=a?e:await d(),n=a?99999:(await p(e)).order+1,e="function"==typeof o?await o({currentBlockUid:e}):o;Array.isArray(e)?await l(t,n,e,r):await window.roam42.common.createBlock(t,n,r(e))},{isAsync:t,deleteCurrentBlock:!a&&n})},getTags:async n=>{try{var e=(await window.roam42.common.getBlocksReferringToThisPage(n)||[]).reduce((e,t)=>[...e,t[0],...t[0].children&&new RegExp(String.raw`((^\[\[${n}\]\]$|)|(${n}\:\:))`).test(t[0].string)?t[0].children:[]],[]).reduce((e,t)=>[...e,...o(t.string)],[]);return e.length||window.roam42.help.displayMessage(`getOptions: ${n}获取不到索引`,2e3),r(e)}catch(e){console.log("getTags error",e),window.roam42.help.displayMessage("getTags 执行出错",2e3)}}}),utils:e,dateProcessing:n};function y(e,t={}){return new Promise(o=>{window.iziToast.question({timeout:1e4,close:!1,overlay:!0,displayMode:1,id:"question",zindex:999,title:e,position:"center",buttons:[["<button><b>YES</b></button>",function(e,t){e.hide({transitionOut:"fadeOut"},t,"true")},!0],["<button>NO</button>",function(e,t){e.hide({transitionOut:"fadeOut"},t,"false")},!1]],onClosing:function(e,t,n){o("timeout"!==n&&n)},...t})})}const w=async(e,t,n,o)=>{var{currentUid:r,selectUids:a,target:i,pageTitle:c}=o,l=t.string.match(/^\`\`\`javascript\n([\s\S]*)\`\`\`$/);if(l){var s=l[1];const d=Object.getPrototypeOf(async function(){}).constructor;try{var u=await new d("$currentUid","$selectUids","$target","$pageTitle",s)(r,a,i,c);return await window.roam42.common.createBlock(e,t.order,`${u}`)}catch(e){console.log(e)}}l=t.string.match(/<%\s*menu:\s*(.*)\s*%>/);if(!l)return await window.roam42.common.createBlock(e,t.order,await window.roam42.smartBlocks.proccessBlockWithSmartness(t.string));{const m=n[l[1]];m?m.onClick&&m.onClick(o):window.iziToast.error({title:"zh-CN"===navigator.language?`不存在 menu: ${l[1]}`:`no menu named${l[1]} found`,position:"topCenter",timeout:3e3})}};var f="object"==typeof global&&global&&global.Object===Object&&global,v="object"==typeof self&&self&&self.Object===Object&&self,n=(e=f||v||Function("return this")()).Symbol,b=(f=Object.prototype).hasOwnProperty,k=f.toString,_=n?n.toStringTag:void 0,B=Object.prototype.toString,x="[object Null]",C="[object Undefined]",T=n?n.toStringTag:void 0;function U(e){return null==e?void 0===e?C:x:T&&T in Object(e)?function(e){var t=b.call(e,_),n=e[_];try{var o=!(e[_]=void 0)}catch(e){}var r=k.call(e);return o&&(t?e[_]=n:delete e[_]),r}(e):(e=e,B.call(e))}function E(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var O="[object AsyncFunction]",$="[object Function]",z="[object GeneratorFunction]",S="[object Proxy]";function j(e){if(E(e)){e=U(e);return e==$||e==z||e==O||e==S}}var v=e["__core-js_shared__"],P=(f=/[^.]+$/.exec(v&&v.keys&&v.keys.IE_PROTO||""))?"Symbol(src)_1."+f:"",I=Function.prototype.toString,L=/^\[object .+?Constructor\]$/,v=Function.prototype,f=Object.prototype,v=v.toString,f=f.hasOwnProperty,M=RegExp("^"+v.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function A(e){var t;return E(e)&&(t=e,!(P&&P in t))&&(j(e)?M:L).test(function(e){if(null!=e){try{return I.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function D(e,t){t=t,t=null==(e=e)?void 0:e[t];return A(t)?t:void 0}var N=D(Object,"create"),q=Object.prototype.hasOwnProperty,R=Object.prototype.hasOwnProperty;function F(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function K(e,t){for(var n,o,r=e.length;r--;)if((n=e[r][0])===(o=t)||n!=n&&o!=o)return r;return-1}F.prototype.clear=function(){this.__data__=N?N(null):{},this.size=0},F.prototype.delete=function(e){return e=this.has(e)&&delete this.__data__[e],this.size-=e?1:0,e},F.prototype.get=function(e){var t=this.__data__;if(N){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return q.call(t,e)?t[e]:void 0},F.prototype.has=function(e){var t=this.__data__;return N?void 0!==t[e]:R.call(t,e)},F.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=N&&void 0===t?"__lodash_hash_undefined__":t,this};var H=Array.prototype.splice;function Y(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}Y.prototype.clear=function(){this.__data__=[],this.size=0},Y.prototype.delete=function(e){var t=this.__data__;return!((e=K(t,e))<0)&&(e==t.length-1?t.pop():H.call(t,e,1),--this.size,!0)},Y.prototype.get=function(e){var t=this.__data__;return(e=K(t,e))<0?void 0:t[e][1]},Y.prototype.has=function(e){return-1<K(this.__data__,e)},Y.prototype.set=function(e,t){var n=this.__data__,o=K(n,e);return o<0?(++this.size,n.push([e,t])):n[o][1]=t,this};var G=D(e,"Map");function V(e,t){var n,o=e.__data__;return("string"==(e=typeof(n=t))||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function W(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function X(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new W;++t<n;)this.add(e[t])}function J(e){return e!=e}function Q(e,t,n){return t==t?function(e,t,n){for(var o=n-1,r=e.length;++o<r;)if(e[o]===t)return o;return-1}(e,t,n):function(e,t,n,o){for(var r=e.length,a=n+(o?1:-1);o?a--:++a<r;)if(t(e[a],a,e))return a;return-1}(e,J,n)}function Z(e,t){return!!(null==e?0:e.length)&&-1<Q(e,t,0)}function ee(e,t,n){for(var o=-1,r=null==e?0:e.length;++o<r;)if(n(t,e[o]))return!0;return!1}function te(e,t){return e.has(t)}function ne(e,t,n,o){var r,a=-1,i=Z,c=!0,l=e.length,s=[],u=t.length;if(!l)return s;n&&(t=function(e,t){for(var n=-1,o=null==e?0:e.length,r=Array(o);++n<o;)r[n]=t(e[n],n,e);return r}(t,(r=n,function(e){return r(e)}))),o?(i=ee,c=!1):200<=t.length&&(i=te,c=!1,t=new X(t));e:for(;++a<l;){var d=e[a],m=null==n?d:n(d),d=o||0!==d?d:0;if(c&&m==m){for(var p=u;p--;)if(t[p]===m)continue e;s.push(d)}else i(t,m,o)||s.push(d)}return s}function oe(e){return null!=e&&"object"==typeof e}function re(e){return oe(e)&&"[object Arguments]"==U(e)}W.prototype.clear=function(){this.size=0,this.__data__={hash:new F,map:new(G||Y),string:new F}},W.prototype.delete=function(e){return e=V(this,e).delete(e),this.size-=e?1:0,e},W.prototype.get=function(e){return V(this,e).get(e)},W.prototype.has=function(e){return V(this,e).has(e)},W.prototype.set=function(e,t){var n=V(this,e),o=n.size;return n.set(e,t),this.size+=n.size==o?0:1,this},X.prototype.add=X.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},X.prototype.has=function(e){return this.__data__.has(e)};var ae=(e=Object.prototype).hasOwnProperty,ie=e.propertyIsEnumerable,ce=re(function(){return arguments}())?re:function(e){return oe(e)&&ae.call(e,"callee")&&!ie.call(e,"callee")},le=Array.isArray,se=n?n.isConcatSpreadable:void 0;function ue(e){return le(e)||ce(e)||!!(se&&e&&e[se])}function de(e,t,n,o,r){var a=-1,i=e.length;for(n=n||ue,r=r||[];++a<i;){var c=e[a];0<t&&n(c)?1<t?de(c,t-1,n,o,r):function(e,t){for(var n=-1,o=t.length,r=e.length;++n<o;)e[r+n]=t[n]}(r,c):o||(r[r.length]=c)}return r}function me(e){return e}var pe=Math.max;function he(a,i,c){return i=pe(void 0===i?a.length-1:i,0),function(){for(var e=arguments,t=-1,n=pe(e.length-i,0),o=Array(n);++t<n;)o[t]=e[i+t];for(var t=-1,r=Array(i+1);++t<i;)r[t]=e[t];return r[i]=c(o),function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}(a,this,r)}}var ge,ye,we,fe=function(){try{var e=D(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),n=fe?function(e,t){return fe(e,"toString",{configurable:!0,enumerable:!1,value:(n=t,function(){return n}),writable:!0});var n}:me,ve=Date.now,n=(ge=n,we=ye=0,function(){var e=ve(),t=16-(e-we);if(we=e,0<t){if(800<=++ye)return arguments[0]}else ye=0;return ge.apply(void 0,arguments)}),be=9007199254740991;function ke(e){return null!=e&&("number"==typeof(t=e.length)&&-1<t&&t%1==0&&t<=be)&&!j(e);var t}function _e(e){return oe(e)&&ke(e)}var Be,xe=n(he(n=function(e,t){return _e(e)?ne(e,de(t,1,_e,!0)):[]},Be,me),n+""),Ce=[{text:"Delete",key:"Delete",children:[{text:"Delete block and its references",key:"Delete block and its references",onClick:async({currentUid:e,selectUids:t})=>{await y("zh-CN"===navigator.language?"确定删除当前所选 block 及其所有块引用":"Sure to delete the current block and its all references??")&&[e,...t].forEach(async e=>{const t=await window.roam42.common.getBlocksReferringToThisBlockRef(e);0<t.length&&t.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)),window.roam42.common.deleteBlock(e)})}},{text:"Delete current block and embed block's refers",key:"Delete current block and embed block's refers",onClick:async({currentUid:e})=>{try{const n=await g.common.getCurrentBlockInfo(e);var t=n.string.match(/\{\{\[\[embed\]\]\:\s+\(\(\(\((.*?)\)\)\)\)\}\}/);if(t){t=t[1];const o=await window.roam42.common.getBlocksReferringToThisBlockRef(t);0<o.length&&await y(`该 block 包含有 embed，embed 原 block有${o.length}个块引用，是否一起删除`)&&(o.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)),window.roam42.common.deleteBlock(t),window.roam42.help.displayMessage(`删除${o.length}个引用`,2e3))}window.roam42.common.deleteBlock(e)}catch(e){console.log(e),window.roam42.help.displayMessage("删除出错",2e3)}}}]},{text:"Format",key:"Format",children:[{text:"Remove tags",key:"Remove tags",onClick:async({currentUid:e,selectUids:t})=>{[e,...t].forEach(async e=>{var t=await g.common.getCurrentBlockInfo(e);await window.roam42.common.updateBlock(e,g.utils.removeTags(t.string))})}}]},{text:"Format child blocks",key:"Format child blocks",children:[{text:"Embed to text",key:"Child embed to text",onClick:async({currentUid:e})=>{await g.utils.patchBlockChildren(e,async e=>{var t=e.string.match(/\{\{\[\[embed\]\]\:\s+\(\(\(\((.*?)\)\)\)\)\}\}/),t=t&&t[1];t&&(t=await window.roam42.common.getBlockInfoByUID(t),window.roam42.common.updateBlock(e.uid,t[0][0].string))})}},{text:"Remove tags",key:"Child blocks remove tags",onClick:async({currentUid:e})=>{g.utils.patchBlockChildren(e,e=>{window.roam42.common.updateBlock(e.uid,g.utils.removeTags(e.string))})}},{text:"Merge blocks",key:"Merge child blocks",onClick:async({currentUid:o})=>{var r=+window.prompt("zh-CN"===navigator.language?"每多少行为一组进行合并？":"How many lines into one?");if(r){var a=window.prompt("zh-CN"===navigator.language?" 前缀？":"prefix?");const e=await window.roam42.common.getBlockInfoByUID(o,!0);var i=e[0][0].children.sort((e,t)=>e.order-t.order);let t="",n=0;for(let e=0;e<i.length;e++){var c=i[e];window.roam42.common.deleteBlock(c.uid),t+=`${t?"\n":""}${c.string}`,(e>r-2&&(e+1)%r==0||e===i.length-1)&&(window.roam42.common.createBlock(o,n++,`${a}${t}`),t="")}}}}]},{text:"Cloze",key:"Cloze",children:[{text:"Expand all",key:"Expand all cloze",onClick:async({target:e})=>{e.closest(".roam-block-container").querySelectorAll(".rm-block-children .rm-paren > .rm-spacer").forEach(e=>e.click())}},{text:"Collapse all",key:"Collapse all cloze",onClick:async({target:e})=>{e.closest(".roam-block-container").querySelectorAll(".rm-block-children .rm-paren__paren").forEach(e=>e.click())}}]},{text:"Extract",children:[{text:"All children's highlight",key:"Extract All children's highlight",onClick:async({currentUid:e})=>{let t=[];await g.utils.patchBlockChildren(e,e=>{e=e.string.match(/\^\^([\s\S]*?)\^\^/g);e&&t.push(...e)}),await navigator.clipboard.writeText(t.join("\n")),0<t.length?window.roam42.help.displayMessage("提取高亮成功，已复制到剪切板",2e3):window.roam42.help.displayMessage("提取不到高亮内容",2e3)}}]}],Te=[{text:"0000",key:"0000",onClick:()=>{}},{text:"Delete all refering blocks",key:"Delete all refering blocks",onClick:async({pageTitle:e})=>{const t=await window.roam42.common.getBlocksReferringToThisPage(e);t.length?await y(`当前页面有${t.length}个引用，是否全部删除？`)&&t.forEach(async e=>window.roam42.common.deleteBlock(e[0].uid)):window.iziToast.info({title:"该页面没有引用",position:"topCenter",timeout:2e3})}},{text:"Extract currentPage's refers",key:"Extract currentPage's refers",onClick:async({pageTitle:e})=>{const t=await window.roam42.common.getBlocksReferringToThisPage(e);if(t.length){var n=t.reduce((e,t)=>{return e[t[0].uid]=t,e},{});const o=await window.roam42.common.getPageNamesFromBlockUidList(t.map(e=>e[0].uid)),r=o.sort((e,t)=>+new Date(e[1].uid)&&+new Date(t[1].uid)&&+new Date(e[1].uid)>+new Date(t[1].uid)?1:-1).reduce((e,t,n)=>{var o=t[1].uid;return e[o]=[...e[o]||[],{...t[0],title:t[1].title}],e},{});e=Object.keys(r).map(e=>`${r[e][0].title}
          ${r[e].map(e=>{e=e.uid;return"    "+function t(e,n=2){return`${e.string}
              ${e.children?e.children.map(e=>"    ".repeat(n)+t(e,n+1)).join("\n"):""}`}(n[e][0])}).join("\n")}`).join("\n");await navigator.clipboard.writeText(e),window.roam42.help.displayMessage("提取成功，已复制到剪切板",2e3)}else window.roam42.help.displayMessage("提取不到东西",2e3)}}],Ue=[{text:"Focus on page",key:"Focus on page",onClick:async({pageTitle:e})=>{await window.roam42.common.navigateUiTo(e)}},...Te];function Ee(e){const t={},n=e=>{e.forEach(e=>{e.children?n(e.children):t[e.key]=e})};return n(e),t}async function Oe(e,n){return e&&e.length?await Promise.all(e.map(async t=>{if(null===(e=t.children)||void 0===e||!e.length)return{text:t.string,onClick:()=>{window.iziToast.info({title:"zh-CN"===navigator.language?"该菜单没有配置执行任务":"This menu has no configuration",position:"topCenter",timeout:2e3})}};var e=t.string.match(/\{\{(.*)\}\}/);return e?{text:e[1],onClick:async e=>{await async function(e,r,a){var{currentUid:t,pageTitle:n}=a;let o;t?o=t:n&&(o=await window.roam42.common.getPageUidByTitle(n));const i=async(e,t)=>{for(const o of t.sort((e,t)=>e.order-t.order)){var n=await w(e,o,r,a);o.children&&i(n||e,o.children)}};await i(o,e)}(t.children.sort((e,t)=>e.order-t.order),n,e)}}:{text:t.string,children:await Oe(t.children,n)}})):[]}async function $e(e,t,n){const o=e.find(e=>e.string.includes(t));return o?await Oe(o&&o.children.sort((e,t)=>e.order-t.order)||[],Ee(n)):n}const ze={},Se=(e,t="")=>e.map(e=>e.children&&e.children.length?`<li class="bp3-submenu">
                        <span class="bp3-popover-wrapper">
                            <span class="bp3-popover-target">
                                <a class="bp3-menu-item" tabindex="0" data-key="${t+e.text}">
                                    <div class="bp3-text-overflow-ellipsis bp3-fill">${e.text}</div>
                                    <span icon="caret-right" class="bp3-icon bp3-icon-caret-right">
                                        <svg data-icon="caret-right" width="16" height="16" viewBox="0 0 16 16">
                                            <desc>caret-right</desc><path d="M11 8c0-.15-.07-.28-.17-.37l-4-3.5A.495.495 0 006 4.5v7a.495.495 0 00.83.37l4-3.5c.1-.09.17-.22.17-.37z" fill-rule="evenodd">
                                            </path>
                                        </svg>
                                    </span>
                                </a>
                            </span>
                            <div class="bp3-overlay bp3-overlay-inline">
                                <div class="bp3-transition-container bp3-popover-appear-done bp3-popover-enter-done" style="position: absolute; will-change: transform; top: 0px; left: 100%; /*transform: translate3d(183px, 0px, 0px);*/">
                                    <div class="bp3-popover bp3-minimal bp3-submenu" style="transform-origin: left center;">
                                        <div class="bp3-popover-content">
                                            <ul class="bp3-menu">
                                                ${Se(e.children,t+e.text)}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </span>
                    </li>`:(ze[t+e.text]=e.onClick,`<li>
                        <a class="bp3-menu-item bp3-popover-dismiss" data-key="${t+e.text}">
                            <div class="bp3-text-overflow-ellipsis bp3-fill">${e.text}</div>
                        </a>
                    </li>`)).join("");let je,Pe;document.addEventListener("mousedown",e=>{je=e.clientX,Pe=e.clientY});const Ie=new MutationObserver(async(n,e)=>{if(!!n.find(e=>"childList"===e.type&&("bp3-context-menu"===e.target.className||"bp3-context-menu-popover-target"===e.target.className))){let t=n.find(e=>"childList"===e.type&&0<e.addedNodes.length&&"bp3-portal"===e.target.className);if(t){const o=document.elementsFromPoint(je,Pe),r={};let e=null;r.target=o[1];const a=o.find(e=>e.classList.contains("rm-block-main"));a&&(r.currentUid=i(a.querySelector(".rm-block__input").id),e="block");n=o.find(e=>e.classList.contains("rm-title-display"));n&&(r.pageTitle=n.innerText,r.currentUid=await window.roam42.common.getPageUidByTitle(r.pageTitle),e=o.find(e=>e.classList.contains("sidebar-content"))?"pageTitle_sidebar":"pageTitle");n=await async function(t,n){var e=await window.roam42.common.getPageUidByTitle("roam/enhance/menu");let o;if(e){const r=await window.roam42.common.getBlockInfoByUID(e,!0);r&&(o=r[0][0].children.sort((e,t)=>e.order-t.order))}if(o){if("block"===t)return await $e(o,"BlockMenu",Ce);let e;return e="pageTitle"===t?await $e(o,"PageTitleMenu",Te):await $e(o,"PageTitleMenu_Sidebar",Ue),"roam/enhance/menu"===n.pageTitle&&e.push({text:"Pull all build-in menu",onClick:async()=>{var e=await window.roam42.common.getPageUidByTitle("roam/enhance/menu");const t=e=>e.map(e=>e.children?{...e,children:t(e.children)}:{...e,text:`{{${e.text}}}`,children:[{text:`<%menu:${e.key}%>`}]});s(e,[{text:"**BlockMenu**",children:t(Ce)},{text:"**PageTitleMenu**",children:t(Te)},{text:"**PageTitleMenu_Sidebar**",children:t(Ue)}])}},{text:"Pull unused build-in menu",onClick:async({currentUid:e})=>{const t=[];await g.utils.patchBlockChildren(e,e=>{e=e.string.match(/<%\s*menu:\s*(.*)\s*%>/);e&&t.push(e[1])});var n=Object.keys({...Ee(Ce),...Ee(Te),...Ee(Ue)}),n=xe(n,t).map(e=>`<%${e}%>`);n.length?await g.common.batchCreateBlocks(e,0,n):window.iziToast.info({title:"zh-CN"===navigator.language?"当前没有未使用的内置菜单":"No unused build-in menu found"})}}),e}}((o,e),r);r.selectUids=c(),n&&function(e,t,o){const n=document.createElement("template");n.innerHTML=Se(t),[...n.content.childNodes].forEach(e=>{e.addEventListener("click",async e=>{const t=e.target;if(t.classList.contains("bp3-menu-item")||t.classList.contains("bp3-fill")&&t.classList.contains("bp3-text-overflow-ellipsis")){const n=ze[t.closest(".bp3-menu-item").dataset.key];if(n)try{await n(o)}catch(e){console.log(e),window.iziToast.error({title:"操作失败",position:"topCenter",timeout:3e3})}}}),[...e.querySelectorAll(".bp3-popover-wrapper")].forEach(e=>{e.addEventListener("mouseenter",async e=>{const t=e.target;t.parentNode.classList.contains("bp3-submenu")&&(t.querySelector(".bp3-popover-target").classList.add("bp3-popover-open"),t.querySelector(".bp3-overlay").classList.add("bp3-overlay-open"))}),e.addEventListener("mouseleave",async e=>{const t=e.target;t.parentNode.classList.contains("bp3-submenu")&&(t.querySelector(".bp3-popover-target").classList.remove("bp3-popover-open"),t.querySelector(".bp3-overlay").classList.remove("bp3-overlay-open"))})})});const r=document.createElement("li");r.className="bp3-menu-divider",n.content.childNodes[n.content.childNodes.length-1].after(r),e.prepend(n.content)}(t.target.querySelector("ul.bp3-menu"),n,r)}}});!function(e,o=""){let r=0;setTimeout(()=>function t(e){var n;try{e()}catch(e){console.log("error",e),r<5&&setTimeout(()=>t(++r),3e3),5<r&&null!==(n=window.roam42)&&void 0!==n&&n.help.displayMessage(`${o}加载失败`,2e3)}}(e),3e3)}(()=>{Ie.observe(document.body,{attributes:!1,childList:!0,subtree:!0})}),void 0===window.yoyo&&(window.yoyo=g,((e,t)=>{const n=document.getElementById(t);n&&n.remove();const o=document.createElement("style");o.textContent=e,t&&(o.id=t),document.getElementsByTagName("head")[0].appendChild(o),o})(`
    .bp3-submenu .bp3-overlay:not(.bp3-overlay-open) {
      display: none;
    }
    .bp3-submenu > .bp3-popover-wrapper {
      position: relative;
    }
    .iziToast > .iziToast-body .iziToast-buttons {
      float: none;
      text-align: center;
      margin-left: -28px;
    }
    .iziToast > .iziToast-body .iziToast-icon {
      top: 20px;
    }
    .iziToast-buttons .iziToast-buttons-child {
      top: 6px;
    }
  `,"roam-enhance"))}();
